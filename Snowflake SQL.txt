--- 1. Create Warehouse ---
USE ROLE SYSADMIN;
CREATE WAREHOUSE POWERBI_WH WITH WAREHOUSE_SIZE = 'XSMALL' WAREHOUSE_TYPE = 'STANDARD' AUTO_SUSPEND = 300 AUTO_RESUME = TRUE MIN_CLUSTER_COUNT = 1 MAX_CLUSTER_COUNT = 1 SCALING_POLICY = 'STANDARD' COMMENT = 'Snowflake Usage Sample Report';


--- 2. Create Database --
USE ROLE SYSADMIN;
CREATE DATABASE POWERBI_SAMPLE_DB COMMENT = 'Snowflake Usage Sample Report';


--- 3. Create Role ---
USE ROLE USERADMIN;
CREATE OR REPLACE ROLE "PBI_READER" COMMENT = 'Snowflake Usage Sample Report';
GRANT ROLE "PBI_READER" TO ROLE "PUBLIC";

-- 4. ASSIGN PERMISSIONS --
USE ROLE SECURITYADMIN;
GRANT USAGE ON DATABASE POWERBI_SAMPLE_DB TO ROLE PBI_READER;
GRANT USAGE ON SCHEMA PUBLIC TO ROLE PBI_READER;
GRANT USAGE ON WAREHOUSE POWERBI_WH TO ROLE PBI_READER;
GRANT SELECT ON ALL VIEWS IN SCHEMA POWERBI_SAMPLE_DB.PUBLIC TO ROLE PBI_READER;

USE ROLE ACCOUNTADMIN;
GRANT IMPORTED PRIVILEGES ON DATABASE SNOWFLAKE to ROLE SYSADMIN;



-- 5. Create User --
USE ROLE USERADMIN;
CREATE USER PBI_SNOWFLAKE_READER PASSWORD = 'mypassword' COMMENT = 'Snowflake Usage Sample Report' LOGIN_NAME = 'PBI_SNOWFLAKE_READER' DISPLAY_NAME = 'PBI_SNOWFLAKE_READER' DEFAULT_ROLE = "PBI_READER" DEFAULT_WAREHOUSE = 'POWERBI_WH' DEFAULT_NAMESPACE = 'POWERBI_SAMPLE_DB' MUST_CHANGE_PASSWORD = FALSE;
GRANT ROLE "PBI_READER" TO USER PBI_SNOWFLAKE_READER;



-- 6. Create Views --

-- 6a. Create Storage Usage View ---
USE ROLE SYSADMIN;
USE DATABASE POWERBI_SAMPLE_DB;
USE SCHEMA PUBLIC;
CREATE OR REPLACE VIEW VW_REP_SNOWFLAKE_STORAGE_USAGE_MONTHLY_SUMMARY
AS
select 
    date_trunc(month, usage_date) as USAGE_MONTH
  , avg(storage_bytes + stage_bytes + failsafe_bytes) / power(1024, 4) as TOTAL_BILLABLE_STORAGE_TB
  , avg(storage_bytes ) / power(1024, 4) as STORAGE_BILLABLE_STORAGE_TB
  , avg(stage_bytes ) / power(1024, 4) as STAGE_BILLABLE_STORAGE_TB
  , avg(failsafe_bytes ) / power(1024, 4) as FAILSAFE_BILLABLE_STORAGE_TB
from SNOWFLAKE.ACCOUNT_USAGE.STORAGE_USAGE
GROUP BY date_trunc(month, usage_date) 
ORDER BY date_trunc(month, usage_date) ;



-- 6b. Create Credit Usage View --

CREATE OR REPLACE VIEW VW_REP_SNOWFLAKE_WAREHOUSE_METERING_HISTORY
AS
select "START_TIME",
    "END_TIME",
    "WAREHOUSE_ID",
    "WAREHOUSE_NAME",
    "CREDITS_USED",
     TO_DATE(START_TIME) AS START_DATE,
    DATEDIFF(HOUR, START_TIME, END_TIME) AS WAREHOUSE_OPERATION_HOURS,
    TO_TIME(START_TIME) AS TIME_OF_DAY
from "SNOWFLAKE"."ACCOUNT_USAGE"."WAREHOUSE_METERING_HISTORY"
ORDER BY TO_DATE(START_TIME) DESC;



-- 6c. Create Snowpipe Usage History View --

CREATE OR REPLACE VIEW POWERBI_SAMPLE_DB.PUBLIC.VW_REP_SNOWFLAKE_PIPE_USAGE_HISTORY
AS
select 
  PIPE_ID,
  PIPE_NAME,
  START_TIME,
  END_TIME,
  CREDITS_USED,
  BYTES_INSERTED,
  FILES_INSERTED,
  TO_DATE(START_TIME) AS START_DATE,
  DATEDIFF(HOUR, START_TIME, END_TIME) AS PIPELINE_OPERATION_HOURS,
  HOUR(START_TIME) AS TIME_OF_DAY
from "SNOWFLAKE"."ACCOUNT_USAGE"."PIPE_USAGE_HISTORY"
ORDER BY TO_DATE(START_TIME) DESC;



--- 6d. Create Date view containing last 730 days --

CREATE OR REPLACE VIEW POWERBI_SAMPLE_DB.PUBLIC.VW_REP_DATE_DIMENSION
AS
 -- GENERATES A DAY ROW for 730 days
  WITH CTE_DATE_GENERATOR AS (
    SELECT DATEADD(DAY, SEQ4() * -1, CURRENT_DATE) AS DAY_ROW
      FROM TABLE(GENERATOR(ROWCOUNT=>730))  
  )
  SELECT TO_DATE(DAY_ROW) AS DATE 
        ,YEAR(DAY_ROW) AS YEAR
        ,QUARTER(DAY_ROW) AS QUARTER
        ,MONTH(DAY_ROW) AS MONTH_NUM
        ,MONTHNAME(DAY_ROW) AS MONTH_NAME
        ,WEEKOFYEAR(DAY_ROW) AS WEEK_NUM
        ,DAY(DAY_ROW) AS DAY_NUM
        ,DAYNAME(DAY_ROW) AS DAY_NAME
        ,DAYOFWEEK(DAY_ROW) AS DAY_OF_WEEK
        ,DAYOFYEAR(DAY_ROW) AS DAY_OF_YEAR
    FROM CTE_DATE_GENERATOR;
